<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>סיחא</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

    <!-- CSS -->
    <style>
        body{
            background:#0F2027;
            background:-webkit-linear-gradient(to right, #2C5364, #203A43, #0F2027) ;
            background: linear-gradient(to right, #2C5364, #203A43, #0F2027);
        }

        #join-btn{
            position: fixed;
            top:50%;
            left:50%;
            margin-top:-50px;
            margin-left:-100px;
            font-size:18px;
            padding:20px 40px;
        }

        #video-streams{
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            height: 90vh;
            width: 1400px;
            margin:0 auto;
        }

        .video-container{
            max-height: 100%;
            border: 2px solid black;
            background-color: #203A49;
        }

        .video-player{
            height: 100%;
            width: 100%;
        }

        button{
            border:none;
            background-color: cadetblue;
            color:#fff;
            padding:10px 20px;
            font-size:16px;
            margin:2px;
            cursor: pointer;
        }

        #stream-controls{
            display: none;
            justify-content: center;
            margin-top:0.5em;
        }

        @media screen and (max-width:1400px){
            #video-streams{
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                width: 95%;
            }
        }
    </style>
</head>
<body>

    <button id="join-btn">Join Stream</button>

    <div id="stream-wrapper">
        <div id="video-streams"></div>

        <div id="stream-controls">
            <button id="leave-btn">Leave Stream</button>
            <button id="mic-btn" disabled>Mic</button>
            <button id="camera-btn" disabled>Camera</button>
            <button id="screen-btn">Share Screen</button>
        </div>
    </div>
    
    <!-- Agora SDK -->
    <script src="AgoraRTC_N-4.7.3.js"></script>

    <!-- JS -->
    <script>
        const APP_ID = "f3858cfbbe204a14b316640bcb08ec55"
        const TOKEN = "007eJxTYHA23rvCNNPjmMm3uE0LPvd15afP2H//R805y9L63pwV5m4KDGnGFqYWyWlJSalGBiaJhiZJxoZmZiYGSclJBhapyaami2d+zmgIZGT4E+fIyMgAgSA+K0NQfn6uIQMDAP57Idc="
        const CHANNEL = "Room1"

        const client = AgoraRTC.createClient({mode:'rtc', codec:'vp8'})

        let localTracks = { audio: null, video: null }
        let remoteUsers = {}
        let screenTrack = null

        let joinAndDisplayLocalStream = async () => {
            client.on('user-published', handleUserJoined)
            client.on('user-left', handleUserLeft)

            let UID = await client.join(APP_ID, CHANNEL, TOKEN, null)

            // ניסיון ליצור מיקרופון
            try {
                localTracks.audio = await AgoraRTC.createMicrophoneAudioTrack()
            } catch (err) {
                console.warn("אין גישה למיקרופון")
                document.getElementById('mic-btn').innerText = "Mic off"
                document.getElementById('mic-btn').disabled = true
                document.getElementById('mic-btn').style.backgroundColor = "#aaa"
            }

            // ניסיון ליצור מצלמה
            try {
                localTracks.video = await AgoraRTC.createCameraVideoTrack()
            } catch (err) {
                console.warn("אין גישה למצלמה")
                document.getElementById('camera-btn').innerText = "Camera off"
                document.getElementById('camera-btn').disabled = true
                document.getElementById('camera-btn').style.backgroundColor = "#aaa"
            }

            // הצגת הווידאו המקומי
            if (localTracks.video) {
                let player = `<div class="video-container" id="user-container-${UID}">
                                  <div class="video-player" id="user-${UID}"></div>
                              </div>`
                document.getElementById('video-streams').insertAdjacentHTML('beforeend', player)
                localTracks.video.play(`user-${UID}`)

                document.getElementById('camera-btn').innerText = "Camera on"
                document.getElementById('camera-btn').disabled = false
                document.getElementById('camera-btn').style.backgroundColor = "cadetblue"
            }

            // עדכון כפתור מיקרופון
            if (localTracks.audio) {
                document.getElementById('mic-btn').innerText = "Mic on"
                document.getElementById('mic-btn').disabled = false
                document.getElementById('mic-btn').style.backgroundColor = "cadetblue"
            }

            // פרסום ערוצים קיימים
            let tracksToPublish = []
            if (localTracks.audio) tracksToPublish.push(localTracks.audio)
            if (localTracks.video) tracksToPublish.push(localTracks.video)
            if (tracksToPublish.length > 0) await client.publish(tracksToPublish)
        }

        let joinStream = async () => {
            await joinAndDisplayLocalStream()
            document.getElementById('join-btn').style.display = 'none'
            document.getElementById('stream-controls').style.display = 'flex'
        }

        let handleUserJoined = async (user, mediaType) => {
            remoteUsers[user.uid] = user 
            await client.subscribe(user, mediaType)

            if (mediaType === 'video'){
                let player = document.getElementById(`user-container-${user.uid}`)
                if (player) player.remove()

                player = `<div class="video-container" id="user-container-${user.uid}">
                            <div class="video-player" id="user-${user.uid}"></div> 
                        </div>`
                document.getElementById('video-streams').insertAdjacentHTML('beforeend', player)
                user.videoTrack.play(`user-${user.uid}`)
            }

            if (mediaType === 'audio'){
                user.audioTrack.play()
            }
        }

        let handleUserLeft = async (user) => {
            delete remoteUsers[user.uid]
            let el = document.getElementById(`user-container-${user.uid}`)
            if (el) el.remove()
        }

        let leaveAndRemoveLocalStream = async () => {
            for (let key in localTracks) {
                if (localTracks[key]) {
                    localTracks[key].stop()
                    localTracks[key].close()
                    localTracks[key] = null
                }
            }

            if(screenTrack){
                await client.unpublish(screenTrack)
                screenTrack.close()
                screenTrack = null
            }

            await client.leave()
            document.getElementById('join-btn').style.display = 'block'
            document.getElementById('stream-controls').style.display = 'none'
            document.getElementById('video-streams').innerHTML = ''
        }

        let toggleMic = async (e) => {
            if (!localTracks.audio) return
            if (localTracks.audio.muted){
                await localTracks.audio.setMuted(false)
                e.target.innerText = 'Mic on'
                e.target.style.backgroundColor = 'cadetblue'
            } else {
                await localTracks.audio.setMuted(true)
                e.target.innerText = 'Mic off'
                e.target.style.backgroundColor = '#EE4B2B'
            }
        }

        let toggleCamera = async (e) => {
            if (!localTracks.video) return
            if(localTracks.video.muted){
                await localTracks.video.setMuted(false)
                e.target.innerText = 'Camera on'
                e.target.style.backgroundColor = 'cadetblue'
            } else {
                await localTracks.video.setMuted(true)
                e.target.innerText = 'Camera off'
                e.target.style.backgroundColor = '#EE4B2B'
            }
        }

        let toggleScreen = async (e) => {
            if(!screenTrack){
                try{
                    screenTrack = await AgoraRTC.createScreenVideoTrack({}, "auto");
                    let UID = "screen-user";
                    let player = `<div class="video-container" id="user-container-${UID}">
                                    <div class="video-player" id="user-${UID}"></div>
                                  </div>`;
                    document.getElementById('video-streams').insertAdjacentHTML('beforeend', player);
                    screenTrack.play(`user-${UID}`);
                    await client.publish(screenTrack);

                    e.target.innerText = "Stop Sharing";
                    e.target.style.backgroundColor = "#EE4B2B";

                    screenTrack.on("track-ended", () => stopScreenShare(e));
                } catch(err){
                    console.warn("שיתוף מסך נכשל:", err);
                }
            } else {
                stopScreenShare(e);
            }
        }

        let stopScreenShare = async (e) => {
            if(!screenTrack) return;
            await client.unpublish(screenTrack);
            screenTrack.close();
            screenTrack = null;

            let screenContainer = document.getElementById("user-container-screen-user");
            if(screenContainer) screenContainer.remove();

            e.target.innerText = "Share Screen";
            e.target.style.backgroundColor = "cadetblue";
        }

        // Event listeners
        document.getElementById('join-btn').addEventListener('click', joinStream)
        document.getElementById('leave-btn').addEventListener('click', leaveAndRemoveLocalStream)
        document.getElementById('mic-btn').addEventListener('click', toggleMic)
        document.getElementById('camera-btn').addEventListener('click', toggleCamera)
        document.getElementById('screen-btn').addEventListener('click', toggleScreen)
    </script>
</body>
</html>
